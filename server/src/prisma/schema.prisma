generator client {
  moduleFormat = "cjs"
  provider = "prisma-client"
  output   = "../../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  isAdmin   Boolean  @default(false)
  firstName String?
  lastName  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
  @@map("users")
}

model City {
  id            Int      @id @default(autoincrement())
  code          String
  slug          String
  name          String
  population    Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sites         Site[]
  calls         Call[]
  revenues      Revenue[]
  expenses      Expense[]
}

model Site {
  id                    Int          @id @default(autoincrement())
  city_id               Int
  name                  String
  url                   String
  yandex_counter_id     String
  google_counter_id     String?
  yandex_tag_manager_id String?
  google_tag_manager_id String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  city                  City         @relation(fields: [city_id], references: [id], onDelete: Cascade)
  metrics               SiteMetric[]

  @@index([city_id])
}

model SiteMetric {
  id                           Int      @id @default(autoincrement())
  site_id                      Int
  date                         DateTime @db.Date
  yandex_users                 Int      @default(0)
  google_users                 Int      @default(0)
  other_users                  Int      @default(0)
  visit_duration_yandex_in_sec Int      @default(0)
  visit_duration_google_in_sec Int      @default(0)
  visit_duration_other_in_sec  Int      @default(0)
  bounce_yandex                Float    @default(0)
  bounce_google                Float    @default(0)
  bounce_other                 Float    @default(0)
  leads_yandex                 Int      @default(0)
  leads_google                 Int      @default(0)
  leads_other                  Int      @default(0)
  site                         Site     @relation(fields: [site_id], references: [id], onDelete: Cascade)

  @@unique([site_id, date])
  @@index([date])
}

model Call {
  id              Int      @id @default(autoincrement())
  city_id         Int
  date_time       DateTime
  caller_number   String
  region          String
  call_order      Int
  class           String?
  number_name     String?
  project         String
  duration_in_sec Int?
  comment         String?
  redirect_number String?
  city            City     @relation(fields: [city_id], references: [id], onDelete: Cascade)
  
  @@index([city_id])
  @@index([date_time])
}

model Revenue {
  id            Int      @id @default(autoincrement())
  city_id       Int?
  date          DateTime @db.Date
  amount        Decimal  @db.Decimal(12, 2)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  city          City?     @relation(fields: [city_id], references: [id], onDelete: Cascade)
  
  @@index([date])
}

model Expense {
  id      Int      @id @default(autoincrement())
  city_id Int?
  date    DateTime @db.Date
  amount  Decimal  @db.Decimal(12, 2)
  type    String
  comment String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  city    City?     @relation(fields: [city_id], references: [id], onDelete: Cascade)
  
  @@index([date])
}
