generator client {
  moduleFormat = "cjs"
  provider = "prisma-client"
  output   = "../../generated/prisma"
  
}

generator zod {
  provider = "prisma-zod-generator"
  output = "../../../shared/schema"
  config = "./zod-generator.config.json"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  DEACTIVATED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      Role     @default(USER)
  firstName String?
  lastName  String?
  status    UserStatus  @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
}

model City {
  id            Int      @id @default(autoincrement())
  code          String
  slug          String
  name          String
  population    Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sites         Site[]
  revenues      Revenue[]
  expenses      Expense[]
}

model Site {
  id                    Int          @id @default(autoincrement())
  city_id               Int
  name                  String?
  group                 String?
  url                   String
  yandex_counter_id     String
  google_counter_id     String?
  yandex_tag_manager_id String?
  google_tag_manager_id String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  city                  City         @relation(fields: [city_id], references: [id], onDelete: Cascade)
  calls                 Call[]
  callsImport           CallImport[]
  metrics               SiteMetric[]

  @@index([city_id])
}

model SiteMetric {
  id                           Int      @id @default(autoincrement())
  site_id                      Int
  date                         DateTime @db.Date
  yandex_users                 Int      @default(0)
  google_users                 Int      @default(0)
  other_users                  Int      @default(0)
  visit_duration_yandex_in_sec Float    @default(0)
  visit_duration_google_in_sec Float    @default(0)
  visit_duration_other_in_sec  Float    @default(0)
  bounce_yandex                Float    @default(0)
  bounce_google                Float    @default(0)
  bounce_other                 Float    @default(0)
  leads_yandex                 Int      @default(0)
  leads_google                 Int      @default(0)
  leads_other                  Int      @default(0)
  site                         Site     @relation(fields: [site_id], references: [id], onDelete: Cascade)

  @@unique([site_id, date])
  @@index([date])
}

model CallImport {
  id                Int       @id @default(autoincrement())
  site_id           Int
  date              DateTime  // Дата и время звонка
  src               String    // Номер звонящего (Кто звонил)
  region            String?   // Регион звонящего (Откуда)
  call_number       Int       // Порядковый номер звонка (№)
  class             String?   // Класс звонка (Класс) - например "Лид"
  project_title     String    // Название проекта (Проект)
  adv_channel_name  String    // Название канала (Куда звонил)
  billsec           Int       // Длительность разговора в секундах (Запись)
  comment           String?   // Комментарий
  redirect_number   String?   // Номер переадресации (Вызов завершен)
  source            String    @default("csv") // Источник данных
  imported_at       DateTime  @default(now()) // Время импорта
  
  site              Site      @relation(fields: [site_id], references: [id], onDelete: Cascade)
  
  @@index([site_id])
}

model Call {
  id                Int       @id @default(autoincrement())
  site_id           Int  
  gudok_id          Int       @unique // ID звонка в Гудок (null для CSV данных)
  project_id        Int       // ID проекта в Гудок
  project_title     String    // Название проекта
  dst               String    // Гудок-номер (виртуальный номер)
  adv_channel_id    String    // ID Гудок-номера
  adv_channel_name  String    // Название Гудок-номера
  src               String    // Номер звонящего
  duration          Int       // Продолжительность всего звонка (сек)
  billsec           Int       // Продолжительность разговора (сек)
  callstatus        String    // BUSY, ANSWERED, NO ANSWER
  date              DateTime  // Дата и время звонка (UTC)
  region            String    // Регион звонящего
  call_number       Int       // Какой по счету звонок с этого номера
  audio             String    // Ссылка на запись разговора

  source            String    @default("webhook") // webhook или csv (после merge)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  
  site              Site      @relation(fields: [site_id], references: [id], onDelete: Cascade)
  
  @@index([site_id])
}

model Revenue {
  id            Int      @id @default(autoincrement())
  city_id       Int?
  date          DateTime @db.Date
  amount        Decimal  @db.Decimal(12, 2)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  city          City?     @relation(fields: [city_id], references: [id], onDelete: Cascade)
  
  @@index([date])
}

model Expense {
  id        Int      @id @default(autoincrement())
  city_id   Int?
  date      DateTime @db.Date
  amount    Decimal  @db.Decimal(12, 2)
  type      String
  comment   String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  city      City?     @relation(fields: [city_id], references: [id], onDelete: Cascade)
  
  @@index([date])
}
