generator client {
  moduleFormat = "cjs"
  provider = "prisma-client"
  output   = "../../generated/prisma"
}

generator zod {
  provider = "prisma-zod-generator"
  output = "../../../shared/schema"
  config = "./zod-generator.config.json"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  DEACTIVATED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      Role     @default(USER)
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  status    UserStatus  @default(ACTIVE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@map("users")
}

model City {
  id            Int      @id @default(autoincrement())
  code          String
  slug          String
  name          String
  population    Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  sites         Site[]
  revenues      Revenue[]
  expenses      Expense[]

  @@map("cities")
}

model Site {
  id                    Int          @id @default(autoincrement())
  cityId                Int          @map("city_id")
  name                  String?
  group                 String?
  url                   String
  yandexCounterId       String       @map("yandex_counter_id")
  googleCounterId       String?      @map("google_counter_id")
  yandexTagManagerId    String?      @map("yandex_tag_manager_id")
  googleTagManagerId    String?      @map("google_tag_manager_id")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  city                  City         @relation(fields: [cityId], references: [id], onDelete: Cascade)
  calls                 Call[]
  callsImport           CallImport[]
  metrics               SiteMetric[]

  @@index([cityId])
  @@map("sites")
}

model SiteMetric {
  id                         Int      @id @default(autoincrement())
  siteId                     Int      @map("site_id")
  date                       DateTime @db.Date
  yandexUsers                Int      @default(0) @map("yandex_users")
  googleUsers                Int      @default(0) @map("google_users")
  otherUsers                 Int      @default(0) @map("other_users")
  visitDurationYandexInSec   Float    @default(0) @map("visit_duration_yandex_in_sec")
  visitDurationGoogleInSec   Float    @default(0) @map("visit_duration_google_in_sec")
  visitDurationOtherInSec    Float    @default(0) @map("visit_duration_other_in_sec")
  bounceYandex               Float    @default(0) @map("bounce_yandex")
  bounceGoogle               Float    @default(0) @map("bounce_google")
  bounceOther                Float    @default(0) @map("bounce_other")
  leadsYandex                Int      @default(0) @map("leads_yandex")
  leadsGoogle                Int      @default(0) @map("leads_google")
  leadsOther                 Int      @default(0) @map("leads_other")

  site                       Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, date])
  @@index([date])
  @@map("site_metrics")
}

model CallImport {
  id                Int       @id @default(autoincrement())
  siteId            Int       @map("site_id")
  date              DateTime
  src               String
  region            String?
  callNumber        Int       @map("call_number")
  class             String?
  projectTitle      String    @map("project_title")
  advChannelName    String    @map("adv_channel_name")
  billsec           Int
  comment           String?
  redirectNumber    String?   @map("redirect_number")
  source            String    @default("csv")
  importedAt        DateTime  @default(now()) @map("imported_at")

  site              Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@map("call_imports")
}

model Call {
  id                Int       @id @default(autoincrement())
  siteId            Int       @map("site_id")
  gudokId           Int       @unique @map("gudok_id")           // ID звонка в Гудок (null для CSV данных)
  projectId         Int       @map("project_id")                 // ID проекта в Гудок
  projectTitle      String    @map("project_title")              // Название проекта
  dst               String                                       // Гудок-номер (виртуальный номер)
  advChannelId      String    @map("adv_channel_id")             // ID Гудок-номера
  advChannelName    String    @map("adv_channel_name")           // Название Гудок-номера
  src               String                                       // Номер звонящего
  duration          Int                                          // Продолжительность всего звонка (сек)
  billsec           Int                                          // Продолжительность разговора (сек)
  callstatus        String                                       // BUSY, ANSWERED, NO ANSWER
  date              DateTime                                     // Дата и время звонка (UTC)
  region            String                                       // Регион звонящего
  callNumber        Int       @map("call_number")                // Какой по счету звонок с этого номера
  audio             String                                       // Ссылка на запись разговора

  source            String    @default("webhook")                // webhook или csv (после merge)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  site              Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
   @@map("calls")
}

model Revenue {
  id            Int      @id @default(autoincrement())
  cityId        Int?     @map("city_id")
  date          DateTime @db.Date
  amount        Decimal  @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  city          City?    @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@index([date])
  @@map("revenues")
}

model Expense {
  id        Int      @id @default(autoincrement())
  cityId    Int?     @map("city_id")
  date      DateTime @db.Date
  amount    Decimal  @db.Decimal(12, 2)
  type      String
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  city      City?    @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@index([date])
  @@map("expenses")
}
